<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detection Tool | Certimailer</title>
  <link rel="stylesheet" href="css/detection_style.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

  <header>
    <h2 class="logo">Certimailer</h2>
    <nav>
      <ul>
        <li><a href="homepage.html">Home</a></li>
        <li><a href="detection.html" class="active">Detection Tool</a></li>
        <li><a href="header-analyzer.html">Header Analyzer</a></li>
        <li><a href="visualization.html">Visualization</a></li>
        <li><a href="learning.html">Learning</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </nav>
  </header>

  <!-- TOP CONTROLS (Print only mainly, theme toggle removed as we enforce dark scheme) -->
  <div class="top-controls" style="top: 100px;">
    <button class="icon-btn" onclick="window.print()" title="Export Report">
      <i class="fas fa-file-pdf"></i>
    </button>
  </div>

  <main class="page detection">
    <section class="page-hero">
      <p class="kicker">REAL-TIME ANALYSIS</p>
      <h1 class="page-title">Email Security Visualizer</h1>
      <p class="page-subtitle">
        Enter a domain to visualize its SPF, DKIM, and DMARC security posture.
      </p>
    </section>

    <div id="inputSection">
      <input type="text" id="domainInput" placeholder="Domain (e.g. google.com)">
      <input type="text" id="selectorInput" placeholder="DKIM Selector (Optional)">
      <button class="main-btn" onclick="runAnalysis()">Visualize Security</button>
    </div>

    <div id="scorecard">
      <div class="grade-circle" id="gradeCircle">-</div>
    </div>

    <div id="actionBanner">Action Plan Loading...</div>

    <div id="chartsContainer">
      <div class="chartBox">
        <h3>Pass/Fail Status</h3>
        <div class="canvas-container"><canvas id="barChart"></canvas></div>
      </div>
      <div class="chartBox">
        <h3>Protocol Mix</h3>
        <div class="canvas-container"><canvas id="pieChart"></canvas></div>
      </div>
      <div class="chartBox">
        <h3>Security Profile</h3>
        <div class="canvas-container"><canvas id="radarChart"></canvas></div>
      </div>
    </div>

    <div class="info-container">
      <div class="detect-card" id="card-spf">
        <h3>SPF</h3>
        <p>Authorized IP list.</p>
        <div id="decoder-spf" class="decoder-area"></div>

        <code class="detect-code"><span id="raw-spf">Waiting...</span></code>

        <div id="fix-spf" class="fix-box">
          <span class="fix-label"><i class="fas fa-wrench"></i> SUGGESTED FIX</span>
          <code class="detect-code" id="code-fix-spf"></code>
        </div>
      </div>

      <div class="detect-card" id="card-dkim">
        <h3>DKIM</h3>
        <p>Digital Signature.</p>
        <code class="detect-code"><span id="raw-dkim">Waiting...</span></code>
      </div>

      <div class="detect-card" id="card-dmarc">
        <h3>DMARC</h3>
        <div class="traffic-light">
          <div id="light-none" class="light"></div>
          <div id="light-quar" class="light"></div>
          <div id="light-reject" class="light"></div>
        </div>
        <div id="decoder-dmarc" class="decoder-area"></div>

        <code class="detect-code"><span id="raw-dmarc">Waiting...</span></code>

        <div id="fix-dmarc" class="fix-box">
          <span class="fix-label"><i class="fas fa-wrench"></i> SUGGESTED FIX</span>
          <code class="detect-code" id="code-fix-dmarc"></code>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-content">
      <p>Â© 2025 Certimailer. All Rights Reserved.</p>
      <p class="footer-note">Built to promote secure email practices through interactive detection and education
        tools
      </p>
    </div>
  </footer>

  <script>
    let barChart, pieChart, radarChart;
    let currentDomain = "";

    // --- DNS LOGIC ---
    async function queryDNS(name, type = 'TXT') {
      try {
        const response = await fetch(`https://dns.google/resolve?name=${name}&type=${type}`);
        const json = await response.json();
        if (json.Answer) {
          return json.Answer.map(rec => rec.data.replace(/^"|"$/g, '')).join('');
        }
        return null;
      } catch (e) { return null; }
    }

    async function runAnalysis() {
      const inputField = document.getElementById('domainInput');
      let rawInput = inputField.value.trim();
      const selector = document.getElementById('selectorInput').value.trim();
      const btn = document.querySelector('.main-btn');

      if (!rawInput) { alert("Enter a domain"); return; }
      currentDomain = rawInput.includes('@') ? rawInput.split('@').pop() : rawInput;
      inputField.value = currentDomain;

      btn.textContent = "Scanning...";
      btn.disabled = true;
      document.getElementById('scorecard').style.display = 'block';
      document.getElementById('actionBanner').style.display = 'none';
      resetUI();

      // --- FETCH ---
      const spfRaw = await queryDNS(currentDomain, 'TXT');
      const spfFound = spfRaw && spfRaw.includes("v=spf1");
      const spfData = spfFound ? extractRecord(spfRaw, "v=spf1") : "Missing";

      const dmarcRaw = await queryDNS(`_dmarc.${currentDomain}`, 'TXT');
      const dmarcFound = dmarcRaw && dmarcRaw.includes("v=DMARC1");
      const dmarcData = dmarcFound ? dmarcRaw : "Missing";

      let dkimFound = false;
      let dkimData = "Missing (Selector required)";
      if (selector) {
        const dkimRaw = await queryDNS(`${selector}._domainkey.${currentDomain}`, 'TXT');
        dkimFound = dkimRaw && dkimRaw.includes("v=DKIM1");
        dkimData = dkimFound ? dkimRaw : "Missing";
      }

      // --- UPDATE UI ---
      updateCard('spf', spfFound, spfData);
      updateCard('dkim', dkimFound, dkimData);
      updateCard('dmarc', dmarcFound, dmarcData);

      if (spfFound) decodeSPF(spfData);
      if (dmarcFound) decodeDMARC(dmarcData);

      // Generate Fixes if Missing
      if (!spfFound) generateFix('spf');
      if (!dmarcFound) generateFix('dmarc');

      updateTrafficLight(dmarcData);
      updateCharts(spfFound, dkimFound, dmarcFound);
      updateGradeAndBanner(spfFound, dkimFound, dmarcFound);

      btn.textContent = "Visualize Security";
      btn.disabled = false;
    }

    function extractRecord(fullText, key) {
      if (!fullText.includes(key)) return fullText;
      return fullText;
    }

    // --- SMART REMEDIATION ---
    function generateFix(type) {
      const box = document.getElementById(`fix-${type}`);
      const code = document.getElementById(`code-fix-${type}`);

      if (!box) return;

      box.style.display = 'block';

      if (type === 'spf') {
        code.textContent = `v=spf1 mx include:${currentDomain} ~all`;
      } else if (type === 'dmarc') {
        code.textContent = `v=DMARC1; p=none; rua=mailto:admin@${currentDomain}`;
      }
    }

    // --- DECODERS ---
    function createChip(text, type, containerId) {
      const chip = document.createElement('div');
      chip.className = `chip ${type}`;
      chip.textContent = text;
      document.getElementById(containerId).appendChild(chip);
    }

    function decodeSPF(record) {
      const parts = record.split(' ');
      const container = 'decoder-spf';
      document.getElementById(container).innerHTML = '';
      parts.forEach(part => {
        if (part.startsWith('v=spf')) createChip(part, 'version', container);
        else if (part.endsWith('all')) createChip(part, 'policy', container);
        else createChip(part, 'mechanism', container);
      });
    }

    function decodeDMARC(record) {
      const parts = record.split(';');
      const container = 'decoder-dmarc';
      document.getElementById(container).innerHTML = '';
      parts.forEach(part => {
        part = part.trim();
        if (!part) return;
        if (part.startsWith('v=DMARC')) createChip(part, 'version', container);
        else if (part.startsWith('p=')) createChip(part, 'policy', container);
        else createChip(part, 'mechanism', container);
      });
    }

    function updateCard(type, isPass, data) {
      const card = document.getElementById(`card-${type}`);
      const rawSpan = document.getElementById(`raw-${type}`);
      const fixBox = document.getElementById(`fix-${type}`);

      card.classList.remove('pass', 'fail');
      card.classList.add(isPass ? 'pass' : 'fail');
      rawSpan.textContent = data.length > 200 ? data.substring(0, 200) + "..." : data;

      // Reset internals
      if (fixBox) fixBox.style.display = 'none';
      const decoder = document.getElementById(`decoder-${type}`);
      if (decoder && !isPass) decoder.innerHTML = '';
    }

    function updateTrafficLight(dmarcRecord) {
      document.querySelectorAll('.light').forEach(l => l.classList.remove('active', 'red', 'yellow', 'green'));
      if (dmarcRecord.includes("p=reject")) document.getElementById('light-reject').classList.add('active', 'green');
      else if (dmarcRecord.includes("p=quarantine")) document.getElementById('light-quar').classList.add('active', 'yellow');
      else if (dmarcRecord.includes("p=none")) document.getElementById('light-none').classList.add('active', 'red');
    }

    function updateGradeAndBanner(spf, dkim, dmarc) {
      const score = (spf ? 1 : 0) + (dkim ? 1 : 0) + (dmarc ? 1 : 0);
      const circle = document.getElementById('gradeCircle');
      const banner = document.getElementById('actionBanner');

      let grade = 'F';
      let color = '#ff7675';
      let advice = "Your domain is vulnerable. Setup SPF immediately.";

      if (score === 3) {
        grade = 'A'; color = '#00b894'; advice = "Excellent! Your domain is secure.";
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
      } else if (score === 2) {
        grade = 'B'; color = '#fdcb6e'; advice = "Good start. Fix the missing protocol.";
      } else if (score === 1) {
        grade = 'C'; color = '#e17055'; advice = "Weak security. Missing critical protocols.";
      }

      circle.textContent = grade;
      circle.style.borderColor = color;
      circle.style.color = color;
      banner.style.display = 'block';
      banner.style.backgroundColor = color;
      banner.textContent = advice;
    }

    function resetUI() {
      document.querySelectorAll('.light').forEach(l => l.classList.remove('active', 'red', 'yellow', 'green'));
      document.querySelectorAll('.decoder-area').forEach(d => d.innerHTML = '');
    }

    // --- CHARTS ---
    function updateCharts(spf, dkim, dmarc) {
      const data = [spf ? 1 : 0, dkim ? 1 : 0, dmarc ? 1 : 0];

      // --- COLOR UPDATED HERE: Blue (#2563eb), Green, Yellow ---
      const colors = ['#2563eb', '#00b894', '#fdcb6e'];

      const opts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

      if (barChart) barChart.destroy();
      barChart = new Chart(document.getElementById('barChart'), {
        type: 'bar', data: { labels: ['SPF', 'DKIM', 'DMARC'], datasets: [{ data, backgroundColor: colors, borderRadius: 5 }] },
        options: { ...opts, scales: { y: { display: false } } }
      });

      if (pieChart) pieChart.destroy();
      pieChart = new Chart(document.getElementById('pieChart'), {
        type: 'doughnut', data: { labels: ['SPF', 'DKIM', 'DMARC'], datasets: [{ data: [1, 1, 1], backgroundColor: data.map((v, i) => v ? colors[i] : '#e0e0e0'), borderWidth: 0 }] },
        options: { ...opts, cutout: '75%' }
      });

      if (radarChart) radarChart.destroy();
      radarChart = new Chart(document.getElementById('radarChart'), {
        type: 'radar', data: { labels: ['SPF', 'DKIM', 'DMARC'], datasets: [{ data, backgroundColor: 'rgba(37, 99, 235, 0.2)', borderColor: '#2563eb', pointBackgroundColor: '#2563eb' }] },
        options: { ...opts, scales: { r: { suggestedMin: 0, suggestedMax: 1, ticks: { display: false } } } }
      });
    }
  </script>
</body>

</html>